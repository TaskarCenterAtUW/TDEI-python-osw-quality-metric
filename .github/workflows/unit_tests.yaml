name: Unit Tests
on:
  workflow_dispatch:
  push:
    branches-ignore:
      - '**'
  pull_request:
    branches: [main, dev, stage]

jobs:
  UnitTest:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Determine output folder
      id: set_output_folder
      run: |
        if [[ $GITHUB_EVENT_NAME == "pull_request" ]]; then
          branch_name=$GITHUB_BASE_REF
        else
          branch_name=$GITHUB_REF_NAME
        fi

        if [[ $branch_name == "main" ]]; then
          echo "output_folder=prod" >> $GITHUB_ENV
        elif [[ $branch_name == "stage" ]]; then
          echo "output_folder=stage" >> $GITHUB_ENV
        elif [[ $branch_name == "dev" ]]; then
          echo "output_folder=dev" >> $GITHUB_ENV
        else
          echo "Unknown branch: $branch_name"
          exit 1
        fi

    - name: Run tests with coverage
      run: |
        dynamic_results_path="test_results/${{ env.output_folder }}"
        mkdir -p $dynamic_results_path
        PYTHONPATH=$(pwd) python -m coverage run --source=src -m unittest discover -v tests/
        coverage report > $dynamic_results_path/latest_report.log
        coverage report >> $dynamic_results_path/$(date '+%Y-%m-%d_%H-%M-%S')_report.log  

    - name: Upload report to Azure
      uses: LanceMcCarthy/Action-AzureBlobUpload@v2
      with:
        source_folder: 'test_results/${{ env.output_folder }}'
        destination_folder: '${{ env.output_folder }}/unit_test_results'
        connection_string: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        container_name: 'osw-quality-metric-service'
        clean_destination_folder: false
        delete_if_exists: false
